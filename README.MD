# Автоматизированная система управления медицинскими бригадами скорой помощи

Backend-часть системы для диспетчеризации и мониторинга бригад скорой помощи


## О проекте
В системе 3 роли:
 1. Администратор
 2. Диспетчер
 3. Работник 

Администратор:
 - Управление аккаунтами: просмотр, добавление, редактирование, удаление
 - Управление бригадами: просмотр, добавление, удаление
 - Управление автомобилями: просмотр, добавление, редактирование, удаление
 - Просмотр и генерация отчетности: графики и диаграммы о работе системы за период времени

Диспетчер:
 - Список актуальных вызовов с сортировкой по критичности и времени поступления
 - Карта с метками вызовов и бригад
 - Данные обновляются в реальном времени

Работник:
 - Карточка с информацией о назначенном вызове
 - Карта с метками бригады и текущего вызова
 - Данные обновляются в реальном времени

## Технологический стек

- Язык: Python 3.11
- WEB-фреймворк: FastAPI
- База данных: PostgreSQL 16
- Взаимодействие с БД: SQLAlchemy 2, Alembic
- Валидация данных: Pydantic
- Кэширование: Redis
- Авторизация: JWT-токены
- Документация API: Swagger/OpenAPI

## Реализация
### Архитектура системы
Система построена по слоистой архитектуре:
 1. API-роутер - обработка HTTP-запроса
 2. Pydantic-схема - валидация входных данных
 3. Сервисный слой - выполнение необходимых операций
 4. Репозиторий - работа с БД

### REST API
Основные группы роутеров:
 - ```auth``` - аутентификация и авторизация
 - ```users``` - управление пользователями
 - ```cars``` - управление автомобилями
 - ```teams``` - работа с медицинскими бригадами
 - ```calls``` - обработка вызовов
 - ```notifications``` - система уведомлений
 - ```reports``` - отчетность

### WebSocket
Диспетчеры и работники подключаются к каналу WebSocket при входе в систему и подписываются на оповещения об изменениях, происходящих в системе   

Для диспетчера:
 - Изменения в списке вызовов
 - Доступность бригад

Для работника:
 - Назначенные вызовы
 - Получение маршрута
 - Действия на текущем вызове

### Авторизация
- При входе в систему в cookie устанавливаются ```access_token``` и ```refresh_token```  
- При истечении действия ```access_token``` отправляется запрос на ```/refresh```
- Проверяется ```refresh_token``` и ip пользователя
- При успешной проверке пользователь получает новую пару токенов

### Безопасность
- Передача данных по защищенному протоколу HTTPS и WSS
- Хранение паролей в хэшированном виде
- Защита от CSRF-атак: при входе в cookie устанавливается ```csrf_access_token``` и ```csrf_refresh_token```, которые дополнительно отправляются в заголовке с каждым запросом
- Защита от XSS-атак: ```access_token``` и ```refresh_token```  хранятся в cookie, их невозможно прочитать через JavaScript
- Ограничение количества запросов от 1 пользователя на незащищенные эндпоинты
- Ролевая модель доступа к ресурсам
- Защита от SQL-инъекций благодаря параметризации запросов в ORM


## Запуск
1. Клонировать репозиторий:  
```
git clone https://github.com/Dmitriy-Gavrilov/Medicine.git 
cd Medicine
```
2. Заполнить ```.env``` файл значениями по примеру ```.env.example```, добавить ```.pem``` файлы
3. Запустить Docker-контейнеры:
```
docker compose up --build
```